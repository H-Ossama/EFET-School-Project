{% extends "base.html" %}

{% block title %}Tableau de Bord Admin - EFET{% endblock title %}

{% block head %}
<!-- Dashboard Specific Styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<!-- Mobile Dashboard Fixes -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard-mobile-fix.css') }}">
{% endblock head %}

{% block content %}
<div class="dashboard-wrapper" id="dashboard">
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-container">
                <div class="logo-icon">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h2 class="logo-text">EFET</h2>
            </div>
            <button class="sidebar-toggle" onclick="closeMobileSidebar()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="sidebar-menu">
            <div class="menu-section">
                <h3 class="menu-title">Principal</h3>
                <ul class="menu-list">
                    <li class="menu-item active">
                        <a href="#dashboard-overview" onclick="showSection('dashboard-overview')" data-tooltip="Tableau de Bord">
                            <i class="fas fa-tachometer-alt"></i>
                            <span>Tableau de Bord</span>
                        </a>
                    </li>
                    {% if current_user.role == 'owner' %}
                    <li class="menu-item">
                        <a href="{{ url_for('main.all_users') }}" data-tooltip="Tous les Utilisateurs">
                            <i class="fas fa-users-cog"></i>
                            <span>Tous les Utilisateurs</span>
                        </a>
                    </li>
                    {% endif %}
                    <li class="menu-item">
                        <a href="#students-section" onclick="showSection('students-section')" data-tooltip="Étudiants">
                            <i class="fas fa-users"></i>
                            <span>Étudiants</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#teachers-section" onclick="showSection('teachers-section')" data-tooltip="Enseignants">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>Enseignants</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#majors-section" onclick="showSection('majors-section')" data-tooltip="Filières">
                            <i class="fas fa-graduation-cap"></i>
                            <span>Filières</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="#subjects-section" onclick="showSection('subjects-section')" data-tooltip="Matières">
                            <i class="fas fa-book"></i>
                            <span>Matières</span>
                        </a>
                    </li>
                </ul>
            </div>
            
            <div class="menu-section">
                <h3 class="menu-title">Communication</h3>
                <ul class="menu-list">
                    <li class="menu-item">
                        <a href="#messages-section" onclick="showSection('messages-section')" data-tooltip="Messages">
                            <i class="fas fa-envelope"></i>
                            <span>Messages</span>
                        </a>
                    </li>
                    <li class="menu-item">
                        <a href="{{ url_for('main.admin_notifications') }}" data-tooltip="Notifications">
                            <i class="fas fa-bell"></i>
                            <span>Notifications</span>
                            {% if notifications %}
                            <span class="notification-badge">{{ notifications|selectattr("is_read", "equalto", false)|list|length }}</span>
                            {% endif %}
                        </a>
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="user-profile">
                {% if current_user.is_authenticated and current_user.profile_picture %}
                    <div class="user-avatar profile-image">
                        <img src="{{ url_for('static', filename='uploaded_pictures/' + current_user.profile_picture) }}" onerror="this.style.display='none'; this.parentNode.innerHTML='{% if current_user.name %}{{ current_user.name[0].upper() }}{% else %}A{% endif %}';" alt="{{ current_user.name }}">
                    </div>
                {% else %}
                    <div class="user-avatar">
                        {% if current_user.is_authenticated and current_user.name %}
                            {{ current_user.name[0].upper() }}
                        {% else %}
                            A
                        {% endif %}
                    </div>
                {% endif %}
                <div class="user-info">
                    <span class="user-name">{{ current_user.name }}</span>
                    <span class="user-role">Administrateur</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <button class="mobile-menu-btn" onclick="toggleSidebar()" aria-label="Menu">
                    <i class="fas fa-bars"></i>
                </button>
                <h1 class="page-title">Tableau de Bord Administrateur</h1>
            </div>
            <div class="header-right">
                <div class="header-actions">
                    <a href="{{ url_for('main.admin_notifications') }}" class="action-btn" style="text-decoration:none; color:inherit;">
                        <i class="fas fa-bell"></i>
                        {% if notifications %}
                        <span class="notification-dot">{{ notifications|selectattr("is_read", "equalto", false)|list|length }}</span>
                        {% endif %}
                    </a>
                    <button class="action-btn" onclick="toggleUserMenu()">
                        <i class="fas fa-user-circle"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-error">
            <i class="fas fa-exclamation-triangle"></i>
            <span>{{ messages[0] }}</span>
        </div>
        {% endif %}
        {% endwith %}

        <!-- Dashboard Overview Section -->
        <section id="dashboard-overview" class="content-section active">
            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon students">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ users|length }}</h3>
                        <p>Étudiants</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon teachers">
                        <i class="fas fa-chalkboard-teacher"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ all_teacher|length }}</h3>
                        <p>Enseignants</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon majors">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ majors|length }}</h3>
                        <p>Filières</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon subjects">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ all_subject|length }}</h3>
                        <p>Matières</p>
                    </div>
                </div>
            </div>

            <!-- Recent Activity Dashboard -->
            <div class="dashboard-grid">
                <!-- Recent Students -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Étudiants Récents</h3>
                        <button class="btn-icon" onclick="showSection('students-section')">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="card-content">
                        {% for user in users[:5] %}
                        <div class="user-item">
                            {% if user.profile_picture %}
                                <div class="user-avatar profile-image">
                                    <img src="{{ url_for('static', filename='uploaded_pictures/' + user.profile_picture) }}" onerror="this.style.display='none'; this.parentNode.innerHTML='{{ user.name[0].upper() }}';" alt="{{ user.name }}">
                                </div>
                            {% else %}
                                <div class="user-avatar">{{ user.name[0].upper() }}</div>
                            {% endif %}
                            <span class="student-name">{{ user.name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Recent Messages -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>Messages Récents</h3>
                        <button class="btn-icon" onclick="showSection('messages-section')">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                    <div class="card-content">
                        {% for message in messages[:5] %}
                        <div class="message-item">
                            <div class="message-info">
                                <h4>{{ message.msg_from }}</h4>
                                <p>{{ message.content[:50] }}...</p>
                                <span class="message-date">{{ message.date_sent }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Notifications -->
                {% if notifications %}
                <div class="dashboard-card notifications-card">
                    <div class="card-header">
                        <h3>Notifications</h3>
                        <span class="notification-count">{{ notifications|selectattr("is_read", "equalto", false)|list|length }}</span>
                    </div>
                    <div class="card-content">
                        <a href="{{ url_for('main.admin_notifications') }}" class="notification-alert" style="display:block; text-decoration:none; color:inherit;">
                            <i class="fas fa-bell"></i>
                            <div>
                                <p><strong>{{ notifications|selectattr("is_read", "equalto", false)|list|length }}</strong> nouvelles notifications</p>
                                <span style="color:#3b82f6;">Voir toutes →</span>
                            </div>
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Students Management Section -->
        <section id="students-section" class="content-section">
            <div class="section-header">
                <h2>Gestion des Étudiants</h2>
                <button class="btn-primary" onclick="toggleModal('addStudentModal')">
                    <i class="fas fa-plus"></i>
                    Ajouter Étudiant
                </button>
            </div>
            
            <div class="data-table-container">
                <div class="table-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="studentSearch" onkeyup="searchStudents()" placeholder="Rechercher un étudiant...">
                    </div>
                    <div class="table-actions">
                        <button class="btn-secondary" onclick="exportData('students')">
                            <i class="fas fa-download"></i>
                            Exporter
                        </button>
                    </div>
                </div>

                <div class="modern-table">
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>Étudiant</th>
                                <th>Email</th>
                                <th>Filière</th>
                                <th>Inscription</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users %}
                            <tr>
                                <td>
                                    <div class="user-cell">
                                        {% if user.profile_picture %}
                                            <div class="user-avatar profile-image">
                                                <img src="{{ url_for('static', filename='uploaded_pictures/' + user.profile_picture) }}" onerror="this.style.display='none'; this.parentNode.innerHTML='{{ user.name[0].upper() }}';" alt="{{ user.name }}">
                                            </div>
                                        {% else %}
                                            <div class="user-avatar">{{ user.name[0].upper() }}</div>
                                        {% endif %}
                                        <div class="user-details">
                                            <span class="user-name">{{ user.name }}</span>
                                            <span class="user-id">ID: {{ user.id }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ user.email }}</td>
                                <td>
                                    <span class="badge major-badge">{{ user.major or 'Non définie' }}</span>
                                </td>
                                <td>{{ user.register_date or 'N/A' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-icon edit" onclick="editStudent({{ user.id }})" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <a href="{{ url_for('main.consultGrades', user_id=user.id) }}" class="btn-icon view" title="Notes">
                                            <i class="fas fa-chart-bar"></i>
                                        </a>
                                        <a href="{{ url_for('main.consultPayments', user_id=user.id) }}" class="btn-icon payment" title="Paiements">
                                            <i class="fas fa-credit-card"></i>
                                        </a>
                                        <button class="btn-icon delete" onclick="deleteStudent({{ user.id }})" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Teachers Management Section -->
        <section id="teachers-section" class="content-section">
            <div class="section-header">
                <h2>Gestion des Enseignants</h2>
                <button class="btn-primary" onclick="toggleModal('addTeacherModal')">
                    <i class="fas fa-plus"></i>
                    Ajouter Enseignant
                </button>
            </div>
            
            <div class="data-table-container">
                <div class="modern-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Enseignant</th>
                                <th>Email</th>
                                <th>Téléphone</th>
                                <th>Inscription</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for teacher in all_teacher %}
                            <tr>
                                <td>
                                    <div class="user-cell">
                                        {% if teacher.profile_picture %}
                                            <div class="user-avatar teacher profile-image">
                                                <img src="{{ url_for('static', filename='uploaded_pictures/' + teacher.profile_picture) }}" onerror="this.style.display='none'; this.parentNode.innerHTML='{{ teacher.name[0].upper() }}';" alt="{{ teacher.name }}">
                                            </div>
                                        {% else %}
                                            <div class="user-avatar teacher">{{ teacher.name[0].upper() }}</div>
                                        {% endif %}
                                        <div class="user-details">
                                            <span class="user-name">{{ teacher.name }}</span>
                                            <span class="user-id">ID: {{ teacher.id }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>{{ teacher.email }}</td>
                                <td>{{ teacher.phone or 'N/A' }}</td>
                                <td>{{ teacher.registration or 'N/A' }}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn-icon edit" onclick="editTeacher({{ teacher.id }})" title="Modifier">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <a href="/consultAbsence/{{ teacher.id }}" class="btn-icon view" title="Absences">
                                            <i class="fas fa-calendar-times"></i>
                                        </a>
                                        <button class="btn-icon delete" onclick="deleteTeacher({{ teacher.id }})" title="Supprimer">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Majors Management Section -->
        <section id="majors-section" class="content-section">
            <div class="section-header">
                <h2>Gestion des Filières</h2>
                <button class="btn-primary" onclick="toggleModal('addMajorModal')">
                    <i class="fas fa-plus"></i>
                    Ajouter Filière
                </button>
            </div>
            
            <div class="majors-grid">
                {% for major in majors %}
                <div class="major-card">
                    <div class="major-header">
                        <div class="major-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <h3>{{ major.major_name }}</h3>
                    </div>
                    <div class="major-details">
                        <div class="detail-item">
                            <span class="label">Durée:</span>
                            <span class="value">{{ major.duration }} ans</span>
                        </div>
                        <div class="detail-item">
                            <span class="label">Étudiants:</span>
                            <span class="value">{{ major.number_students or 0 }}</span>
                        </div>
                    </div>
                    <div class="major-actions">
                        <button class="btn-icon edit" onclick="editMajor({{ major.id }})" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteMajor({{ major.id }})" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Subjects Management Section -->
        <section id="subjects-section" class="content-section">
            <div class="section-header">
                <h2>Gestion des Matières</h2>
                <button class="btn-primary" onclick="toggleModal('addSubjectModal')">
                    <i class="fas fa-plus"></i>
                    Ajouter Matière
                </button>
            </div>
            
            <div class="subjects-grid">
                {% for subject in all_subject %}
                <div class="subject-card">
                    <div class="subject-header">
                        <div class="subject-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3>{{ subject.name }}</h3>
                    </div>
                    <div class="subject-details">
                        <div class="teacher-info">
                            <span class="label">Enseignant:</span>
                            <span class="teacher-name">
                                {% for teacher in all_teacher %}
                                    {% if teacher.id == subject.id_prof %}
                                        {{ teacher.name }}
                                    {% endif %}
                                {% endfor %}
                            </span>
                        </div>
                    </div>
                    <div class="subject-actions">
                        <button class="btn-icon edit" onclick="editSubject({{ subject.id }})" title="Modifier">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon delete" onclick="deleteSubject({{ subject.id }})" title="Supprimer">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        <!-- Messages Section -->
        <section id="messages-section" class="content-section">
            <div class="section-header">
                <h2>Messages</h2>
                <button class="btn-primary" onclick="toggleModal('sendMessageModal')">
                    <i class="fas fa-paper-plane"></i>
                    Envoyer Message
                </button>
            </div>
            
            <div class="messages-container">
                <div class="messages-list">
                    {% for message in messages %}
                    <div class="message-card">
                        <div class="message-header">
                            <div class="sender-info">
                                <div class="sender-avatar">
                                {% set found_image = false %}
                                {% for user in users %}
                                    {% if user.name == message.msg_from and user.profile_picture %}
                                        {% set found_image = true %}
                                        <img src="{{ url_for('static', filename='uploaded_pictures/' + user.profile_picture) }}" onerror="this.style.display='none'; this.parentNode.innerHTML='{{ message.msg_from[0].upper() }}';" alt="{{ message.msg_from }}">
                                    {% endif %}
                                {% endfor %}
                                {% if not found_image %}
                                    {{ message.msg_from[0].upper() }}
                                {% endif %}
                                </div>
                                <div class="sender-details">
                                    <span class="sender-name">{{ message.msg_from }}</span>
                                    <span class="recipient">vers {{ message.msg_to }}</span>
                                </div>
                            </div>
                            <span class="message-date">{{ message.date_sent }}</span>
                        </div>
                        <div class="message-content">
                            {{ message.content }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </section>

        <!-- Notifications Section -->
        <section id="notifications-section" class="content-section">
            <div class="section-header">
                <h2>Notifications</h2>
                {% if notifications %}
                <span class="notification-count">{{ notifications|selectattr("is_read", "equalto", false)|list|length }} nouvelles</span>
                {% endif %}
            </div>
            
            {% if notifications %}
            <div class="notifications-container">
                {% for notification in notifications %}
                <a href="{{ url_for('main.admin_notifications') }}" class="notification-card {% if not notification.is_read %}unread{% endif %}">
                    <div class="notification-icon">
                        <i class="fas fa-bell"></i>
                    </div>
                    <div class="notification-content">
                        <h4>{{ notification.title or 'Notification' }}</h4>
                        <p>{{ notification.content or notification.message }}</p>
                        <span class="notification-time">{{ notification.created_at or 'Maintenant' }}</span>
                    </div>
                    {% if not notification.is_read %}
                    <button class="mark-read-btn" onclick="event.stopPropagation(); markAsRead({{ notification.id }})">
                        <i class="fas fa-check"></i>
                    </button>
                    {% endif %}
                </a>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-bell-slash"></i>
                <h3>Aucune notification</h3>
                <p>Vous n'avez aucune notification pour le moment.</p>
            </div>
            {% endif %}
        </section>
    </main>
</div>

<!-- Modern Modals -->

<!-- Add Student Modal -->
<div id="addStudentModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Ajouter un Étudiant</h3>
            <button class="modal-close" onclick="toggleModal('addStudentModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form method="POST" action="/addStudent" class="modal-form">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom</label>
                    <input type="text" name="name" required placeholder="Nom complet">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" required placeholder="email@exemple.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" name="password" required placeholder="Mot de passe">
                </div>
                <div class="form-group">
                    <label>Âge</label>
                    <input type="number" name="age" placeholder="Âge">
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <input type="text" name="address" placeholder="Adresse complète">
                </div>
                <div class="form-group">
                    <label>N° d'inscription</label>
                    <input type="text" name="registration" placeholder="Numéro d'inscription">
                </div>
                <div class="form-group">
                    <label>Genre</label>
                    <select name="gender">
                        <option value="male">Masculin</option>
                        <option value="female">Féminin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Rôle</label>
                    <select name="role">
                        <option value="student">Étudiant</option>
                        <option value="teacher">Enseignant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Filière</label>
                    <select name="major">
                        {% for major in majors %}
                        <option value="{{ major.major_name }}">{{ major.major_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Date d'inscription</label>
                    <input type="date" name="register_date">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="toggleModal('addStudentModal')">Annuler</button>
                <button type="submit" class="btn-primary">Ajouter</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Teacher Modal -->
<div id="addTeacherModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Ajouter un Enseignant</h3>
            <button class="modal-close" onclick="toggleModal('addTeacherModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form method="POST" action="/addStudent" class="modal-form">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom</label>
                    <input type="text" name="name" required placeholder="Nom complet">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" required placeholder="email@exemple.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" name="password" required placeholder="Mot de passe">
                </div>
                <div class="form-group">
                    <label>Âge</label>
                    <input type="number" name="age" placeholder="Âge">
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <input type="text" name="address" placeholder="Adresse complète">
                </div>
                <div class="form-group">
                    <label>N° d'inscription</label>
                    <input type="text" name="registration" placeholder="Numéro d'inscription">
                </div>
                <div class="form-group">
                    <label>Genre</label>
                    <select name="type">
                        <option value="male">Masculin</option>
                        <option value="female">Féminin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date d'inscription</label>
                    <input type="date" name="register_date">
                </div>
            </div>
            <input type="hidden" name="role" value="teacher">
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="toggleModal('addTeacherModal')">Annuler</button>
                <button type="submit" class="btn-primary">Ajouter</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Major Modal -->
<div id="addMajorModal" class="modal-overlay">
    <div class="modal-container small">
        <div class="modal-header">
            <h3>Ajouter une Filière</h3>
            <button class="modal-close" onclick="toggleModal('addMajorModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form method="POST" action="/addMajor" class="modal-form">
            <div class="form-group">
                <label>Nom de la filière</label>
                <input type="text" name="major_name" required placeholder="Nom de la filière">
            </div>
            <div class="form-group">
                <label>Durée (en années)</label>
                <input type="number" name="duration" required placeholder="Durée en années">
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="toggleModal('addMajorModal')">Annuler</button>
                <button type="submit" class="btn-primary">Ajouter</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Subject Modal -->
<div id="addSubjectModal" class="modal-overlay">
    <div class="modal-container small">
        <div class="modal-header">
            <h3>Ajouter une Matière</h3>
            <button class="modal-close" onclick="toggleModal('addSubjectModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form method="POST" action="/addSubject" class="modal-form">
            <div class="form-group">
                <label>Nom de la matière</label>
                <input type="text" name="subject_name" required placeholder="Nom de la matière">
            </div>
            <div class="form-group">
                <label>Enseignant</label>
                <select name="prof_id" required>
                    <option value="">Sélectionner un enseignant</option>
                    {% for teacher in all_teacher %}
                    <option value="{{ teacher.id }}">{{ teacher.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="toggleModal('addSubjectModal')">Annuler</button>
                <button type="submit" class="btn-primary">Ajouter</button>
            </div>
        </form>
    </div>
</div>

<!-- Send Message Modal -->
<div id="sendMessageModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Envoyer un Message</h3>
            <button class="modal-close" onclick="toggleModal('sendMessageModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form method="POST" action="/sendMessage" class="modal-form">
            <div class="form-group">
                <label>Destinataire</label>
                <select name="recipient_id" required>
                    <option value="">Sélectionner un destinataire</option>
                    {% for recipient in users %}
                    <option value="{{ recipient.id }}">{{ recipient.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label>Message</label>
                <textarea name="message" required placeholder="Votre message ici..." rows="5"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="toggleModal('sendMessageModal')">Annuler</button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Envoyer
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Student Modal -->
<div id="editStudentModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Modifier un Étudiant</h3>
            <button class="modal-close" onclick="toggleModal('editStudentModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <form method="POST" action="/editStudent" class="modal-form">
            <input type="hidden" name="user_id" id="edit_user_id">
            <div class="form-grid">
                <div class="form-group">
                    <label>Nom</label>
                    <input type="text" name="name" id="edit_name" required placeholder="Nom complet">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email" id="edit_email" required placeholder="email@exemple.com">
                </div>
                <div class="form-group">
                    <label>Mot de passe</label>
                    <input type="password" name="password" id="edit_password" placeholder="Laisser vide pour ne pas modifier">
                </div>
                <div class="form-group">
                    <label>Âge</label>
                    <input type="number" name="age" id="edit_age" placeholder="Âge">
                </div>
                <div class="form-group">
                    <label>Adresse</label>
                    <input type="text" name="address" id="edit_address" placeholder="Adresse complète">
                </div>
                <div class="form-group">
                    <label>N° d'inscription</label>
                    <input type="text" name="registration" id="edit_registration" placeholder="Numéro d'inscription">
                </div>
                <div class="form-group">
                    <label>Genre</label>
                    <select name="gender" id="edit_gender">
                        <option value="male">Masculin</option>
                        <option value="female">Féminin</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Rôle</label>
                    <select name="role" id="edit_role">
                        <option value="student">Étudiant</option>
                        <option value="teacher">Enseignant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Filière</label>
                    <select name="major" id="edit_major">
                        {% for major in majors %}
                        <option value="{{ major.major_name }}">{{ major.major_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label>Année actuelle</label>
                    <input type="text" name="current_year" id="edit_current_year" placeholder="Année actuelle">
                </div>
                <div class="form-group">
                    <label>Téléphone</label>
                    <input type="text" name="phone" id="edit_phone" placeholder="Numéro de téléphone">
                </div>
                <div class="form-group">
                    <label>Date d'inscription</label>
                    <input type="date" name="register_date" id="edit_register_date">
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="toggleModal('editStudentModal')">Annuler</button>
                <button type="submit" class="btn-primary">Sauvegarder</button>
            </div>
        </form>
    </div>
</div>

<!-- Teacher Edit Modal -->
<div id="editTeacherModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <h3>Modifier l'enseignant</h3>
            <button class="modal-close" onclick="toggleModal('editTeacherModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form method="POST" action="/editTeacher" class="modal-form">
            <input type="hidden" id="edit_teacher_id" name="user_id">
            
            <div class="form-group">
                <label for="edit_teacher_name">Nom</label>
                <input type="text" id="edit_teacher_name" name="name" required>
            </div>
            
            <div class="form-group">
                <label for="edit_teacher_email">Email</label>
                <input type="email" id="edit_teacher_email" name="email" required>
            </div>
            
            <div class="form-group">
                <label for="edit_teacher_password">Mot de passe (laisser vide pour ne pas changer)</label>
                <input type="password" id="edit_teacher_password" name="password">
            </div>
            
            <div class="form-group">
                <label for="edit_teacher_phone">Téléphone</label>
                <input type="text" id="edit_teacher_phone" name="phone">
            </div>
            
            <div class="form-group">
                <label for="edit_teacher_address">Adresse</label>
                <input type="text" id="edit_teacher_address" name="address">
            </div>
            
            <div class="form-group">
                <label for="edit_teacher_speciality">Spécialité</label>
                <input type="text" id="edit_teacher_speciality" name="speciality">
            </div>
            
            <div class="form-group">
                <label for="edit_teacher_role">Rôle</label>
                <select id="edit_teacher_role" name="role" class="form-control">
                    <option value="teacher">Enseignant</option>
                    <option value="student">Étudiant</option>
                    <option value="admin">Administrateur</option>
                </select>
            </div>
            
            <!-- Additional fields that appear when changing to student -->
            <div id="student_fields" style="display: none;">
                <div class="form-group">
                    <label for="edit_teacher_registration">N° d'inscription</label>
                    <input type="text" id="edit_teacher_registration" name="registration">
                </div>
                
                <div class="form-group">
                    <label for="edit_teacher_major">Filière</label>
                    <select id="edit_teacher_major" name="major" class="form-control">
                        {% for major in majors %}
                        <option value="{{ major.major_name }}">{{ major.major_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="edit_teacher_year">Année</label>
                    <select id="edit_teacher_year" name="current_year" class="form-control">
                        <option value="1">1ère année</option>
                        <option value="2">2ème année</option>
                        <option value="3">3ème année</option>
                        <option value="4">4ème année</option>
                        <option value="5">5ème année</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="toggleModal('editTeacherModal')">Annuler</button>
                <button type="submit" class="btn-primary">Sauvegarder</button>
            </div>
        </form>
    </div>
</div>

<script>
// Dashboard Navigation
let sidebarCollapsed = false;
let currentSection = 'dashboard-overview';

function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const dashboard = document.getElementById('dashboard');
    const overlay = document.getElementById('sidebarOverlay');
    
    // Different behavior for mobile vs desktop
    if (window.innerWidth <= 768) {
        // Mobile behavior
        if (sidebar.classList.contains('mobile-open')) {
            // If already open, close it
            closeMobileSidebar();
        } else {
            // Open the sidebar
            sidebar.classList.add('mobile-open');
            // Prevent body scrolling when sidebar is open
            document.body.style.overflow = 'hidden';
            // Show overlay
            if (overlay) overlay.classList.add('active');
        }
    } else {
        // Desktop behavior
        sidebarCollapsed = !sidebarCollapsed;
        
        if (sidebarCollapsed) {
            sidebar.classList.add('collapsed');
            dashboard.classList.add('sidebar-collapsed');
        } else {
            sidebar.classList.remove('collapsed');
            dashboard.classList.remove('sidebar-collapsed');
        }
    }
}

// Function to specifically close mobile sidebar
function closeMobileSidebar() {
    try {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        // Remove mobile-open class from sidebar
        if (sidebar) sidebar.classList.remove('mobile-open');
        
        // Remove active class from overlay
        if (overlay) {
            overlay.classList.remove('active');
            // Extra safety: make sure overlay doesn't block interactions
            overlay.style.pointerEvents = 'none';
        }
        
        // Re-enable body scrolling
        document.body.style.overflow = '';
        
        // Ensure other potentially blocking elements are also reset
        document.querySelectorAll('.modal-overlay.active').forEach(modal => {
            modal.classList.remove('active');
        });
        
        // Extra safety: add emergency-reset class briefly
        document.body.classList.add('emergency-reset');
        setTimeout(() => {
            document.body.classList.remove('emergency-reset');
        }, 500);
    } catch (error) {
        console.error('Error in closeMobileSidebar:', error);
        // Last resort - reload if everything else fails
        if (confirm('The interface appears to be stuck. Reload the page?')) {
            window.location.reload();
        }
    }
}

function showSection(sectionId) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remove active class from all menu items
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // Show selected section
    const targetSection = document.getElementById(sectionId);
    if (targetSection) {
        targetSection.classList.add('active');
    }
    
    // Add active class to corresponding menu item
    const menuLink = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
    if (menuLink) {
        menuLink.closest('.menu-item').classList.add('active');
    }
    
    currentSection = sectionId;
    
    // Update page title
    const pageTitles = {
        'dashboard-overview': 'Tableau de Bord',
        'students-section': 'Gestion des Étudiants',
        'teachers-section': 'Gestion des Enseignants',
        'majors-section': 'Gestion des Filières',
        'subjects-section': 'Gestion des Matières',
        'messages-section': 'Messages',
        'notifications-section': 'Notifications'
    };
    
    document.querySelector('.page-title').textContent = pageTitles[sectionId] || 'Tableau de Bord';
}

// Modal Functions
function toggleModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.classList.toggle('active');
        
        // Prevent body scroll when modal is open
        if (modal.classList.contains('active')) {
            document.body.style.overflow = 'hidden';
        } else {
            document.body.style.overflow = '';
        }
    }
}

// Search Functions
function searchStudents() {
    const input = document.getElementById('studentSearch');
    const filter = input.value.toUpperCase();
    const table = document.getElementById('studentsTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        let found = false;
        const cells = rows[i].getElementsByTagName('td');
        
        for (let j = 0; j < cells.length - 1; j++) {
            const txtValue = cells[j].textContent || cells[j].innerText;
            if (txtValue.toUpperCase().indexOf(filter) > -1) {
                found = true;
                break;
            }
        }
        
        rows[i].style.display = found ? '' : 'none';
    }
}

// Save original function and CRUD Functions
window.originalEditStudent = function(studentId) {
    // Fetch student data for the modal
    fetch(`/get_student_data/${studentId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const student = data.student;
                
                // Populate the form fields
                document.getElementById('edit_user_id').value = student.id;
                document.getElementById('edit_name').value = student.name || '';
                document.getElementById('edit_email').value = student.email || '';
                document.getElementById('edit_password').value = ''; // Clear password field for security
                document.getElementById('edit_age').value = student.age || '';
                document.getElementById('edit_address').value = student.address || '';
                document.getElementById('edit_registration').value = student.registration || '';
                document.getElementById('edit_gender').value = student.gender || 'male';
                document.getElementById('edit_role').value = student.role || 'student';
                document.getElementById('edit_major').value = student.major || '';
                document.getElementById('edit_current_year').value = student.year || '';
                document.getElementById('edit_phone').value = student.phone || '';
                
                // Format date for input if it exists
                if (student.register_date) {
                    // Expected format: yyyy-mm-dd
                    const registerDate = new Date(student.register_date);
                    const formattedDate = registerDate.toISOString().split('T')[0];
                    document.getElementById('edit_register_date').value = formattedDate;
                } else {
                    document.getElementById('edit_register_date').value = '';
                }
                
                // Show the modal
                toggleModal('editStudentModal');
            } else {
                console.error('Failed to fetch student data');
                alert('Impossible de récupérer les données de l\'étudiant.');
            }
        })
        .catch(error => {
            console.error('Error fetching student data:', error);
            alert('Une erreur s\'est produite lors de la récupération des données.');
        });
}

function deleteStudent(studentId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet étudiant ?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/deleteStudent';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'user_id';
        input.value = studentId;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

function editTeacher(teacherId) {
    if (window.originalEditTeacher) {
        window.originalEditTeacher(teacherId);
    } else {
        // Create a basic implementation for teacher editing
        alert('La fonctionnalité d\'édition des enseignants est en cours d\'implémentation.');
    }
}

// Save original function
window.originalEditTeacher = function(teacherId) {
    console.log('Edit teacher:', teacherId);
    
    // Fetch teacher data for the modal
    fetch(`/get_student_data/${teacherId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const teacher = data.student; // The API returns "student" even for teachers
                
                // Populate the form fields
                document.getElementById('edit_teacher_id').value = teacher.id;
                document.getElementById('edit_teacher_name').value = teacher.name || '';
                document.getElementById('edit_teacher_email').value = teacher.email || '';
                document.getElementById('edit_teacher_password').value = ''; // Clear password field for security
                document.getElementById('edit_teacher_phone').value = teacher.phone || '';
                document.getElementById('edit_teacher_address').value = teacher.address || '';
                // Speciality is not in the API, we might need to add it later
                
                // Set role
                const roleSelect = document.getElementById('edit_teacher_role');
                if (roleSelect) {
                    roleSelect.value = teacher.role || 'teacher';
                }
                
                // Show the modal
                toggleModal('editTeacherModal');
                
                // Initialize role change handler
                handleTeacherRoleChange();
            } else {
                console.error('Failed to fetch teacher data');
                alert('Impossible de récupérer les données de l\'enseignant.');
            }
        })
        .catch(error => {
            console.error('Error fetching teacher data:', error);
            alert('Erreur lors de la récupération des données de l\'enseignant.');
        });
}

function deleteTeacher(teacherId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet enseignant ?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/deleteStudent';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'user_id';
        input.value = teacherId;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

function editMajor(majorId) {
    console.log('Edit major:', majorId);
    // Implement major edit functionality
}

function deleteMajor(majorId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette filière ?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/deleteMajor';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'major_id';
        input.value = majorId;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

function editSubject(subjectId) {
    console.log('Edit subject:', subjectId);
    // Implement subject edit functionality
}

function deleteSubject(subjectId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette matière ?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/deleteSubject';
        
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'subject_id';
        input.value = subjectId;
        
        form.appendChild(input);
        document.body.appendChild(form);
        form.submit();
    }
}

// Handle role change in teacher edit form
function handleTeacherRoleChange() {
    const roleSelect = document.getElementById('edit_teacher_role');
    const studentFields = document.getElementById('student_fields');
    
    if (roleSelect && studentFields) {
        // Initial setup
        if (roleSelect.value === 'student') {
            studentFields.style.display = 'block';
        } else {
            studentFields.style.display = 'none';
        }
        
        // Event listener
        roleSelect.addEventListener('change', function() {
            if (this.value === 'student') {
                studentFields.style.display = 'block';
            } else {
                studentFields.style.display = 'none';
            }
        });
    }
}

// Utility Functions
function exportData(type) {
    console.log('Export data:', type);
    // Implement data export functionality
}

function toggleNotifications() {
    showSection('notifications-section');
}

function toggleUserMenu() {
    // Implement user menu dropdown
    console.log('Toggle user menu');
}

function markAsRead(notificationId) {
    // Implement mark notification as read
    console.log('Mark as read:', notificationId);
}

// Event Listeners
document.addEventListener('DOMContentLoaded', function() {
    // Close modals when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-overlay')) {
            e.target.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Allow clicking the sidebar overlay to close the sidebar
        if (e.target.id === 'sidebarOverlay') {
            closeMobileSidebar();
        }
    });
    
    // Initialize responsive behavior
    function handleResize() {
        if (window.innerWidth <= 768) {
            // On mobile, ensure sidebar is closed initially
            closeMobileSidebar();
            
            // Initialize table scroll indicators
            setupTableScrollIndicators();
        }
    }
    
    window.addEventListener('resize', handleResize);
    handleResize(); // Call on load
    
    // Add double-tap to escape functionality for mobile (safety feature)
    let lastTap = 0;
    document.addEventListener('touchend', function(e) {
        const currentTime = new Date().getTime();
        const tapLength = currentTime - lastTap;
        if (tapLength < 500 && tapLength > 0) {
            // Double tap detected
            closeMobileSidebar();
            document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                modal.classList.remove('active');
            });
            document.body.style.overflow = '';
        }
        lastTap = currentTime;
    });
    
    // Add animation classes
    const cards = document.querySelectorAll('.stat-card, .dashboard-card, .major-card, .subject-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('fade-in');
    });
    
    // Setup table scroll indicators
    function setupTableScrollIndicators() {
        const tableContainers = document.querySelectorAll('.data-table-container');
        tableContainers.forEach(container => {
            // Check if container is scrollable
            if (container.scrollWidth > container.clientWidth) {
                container.classList.add('scrollable-right');
                
                // Add scroll event listener
                container.addEventListener('scroll', function() {
                    const scrollLeft = this.scrollLeft;
                    const maxScroll = this.scrollWidth - this.clientWidth;
                    
                    // Handle left indicator
                    if (scrollLeft > 10) {
                        this.classList.add('scrolled-left');
                    } else {
                        this.classList.remove('scrolled-left');
                    }
                    
                    // Handle right indicator
                    if (scrollLeft < maxScroll - 10) {
                        this.classList.add('scrollable-right');
                    } else {
                        this.classList.remove('scrollable-right');
                    }
                });
            }
        });
    }
    
    // Call setupTableScrollIndicators after a short delay to ensure DOM is fully loaded
    setTimeout(setupTableScrollIndicators, 500);
});

// Animation on scroll
function animateOnScroll() {
    const elements = document.querySelectorAll('.fade-in-up');
    elements.forEach(element => {
        const elementTop = element.getBoundingClientRect().top;
        const elementVisible = 150;
        
        if (elementTop < window.innerHeight - elementVisible) {
            element.classList.add('active');
        }
    });
}

window.addEventListener('scroll', animateOnScroll);

// Function to handle profile image errors
document.addEventListener('DOMContentLoaded', function() {
    // Handle profile image errors
    const profileImages = document.querySelectorAll('.profile-image img');
    profileImages.forEach(img => {
        img.addEventListener('error', function() {
            const parent = this.parentNode;
            const userName = this.getAttribute('alt') || 'U';
            this.style.display = 'none';
            parent.innerHTML = userName.charAt(0).toUpperCase();
        });
    });
});

// Define the global editStudent function to call the original
function editStudent(studentId) {
    if (window.originalEditStudent) {
        window.originalEditStudent(studentId);
    }
}

</script>

<!-- Dashboard JavaScript -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

{% endblock %}
